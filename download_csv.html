<script src="https://d3js.org/d3.v4.js"></script>
<script>
var data = [
   ['Foo', 'programmer'],
   ['Bar', 'bus driver'],
   ['Moo', 'Reindeer Hunter']
];
 
 function readCSV(fileNames){
     var queue = [];

    fileNames.forEach( function ( fileName ) {
        var readCSV = new Promise( function(resolve, reject) {
            d3.csv(fileName+'.csv', function(data){
                resolve(data);
            })
        });
        
        queue.push(readCSV);
    });

    return Promise.all(queue);

 }
 
function download_csv() {
var dataset = [];

//file들을 멀티 선택할 수 있게 추가.

var fileNames = ['stockCodeList'];

var getData = readCSV(fileNames);
getData.then(function( csvFileAll ){
    // 1. da
    csvFileAll.forEach(function( csvFile ){
        csvFile.forEach(function( data ){
            var stockInfo = dataset.find( function(stockItem) {
                return stockItem.code == data['code'];
            });

            if( !stockInfo ){
                stockInfo = {
                    'code' : data['code']
                }
            }

            Object.getOwnPropertyNames(data).forEach(function(key){
                if( stockInfo.hasOwnProperty(key) ){
                    //프로퍼티가 존재하면.. 덮어씌운다..

                }else{
                    stockInfo[key] = data[key];
                }
            });

            dataset.push(stockInfo); 
        });
    });
    console.log(dataset);
});

d3.csv("stockCodeList.csv", function(data) {
	dataset = data.map(function(csvItem) {
        var stockInfo = dataset.find( function(stockItem) {
            return stockItem.code == csvItem['code'];
        });

        if( !stockInfo ){
            stockInfo = {
                'code' : csvItem['code']
            }
        }

        Object.getOwnPropertyNames(csvItem).forEach(function(key){
            if( stockInfo.hasOwnProperty(key) ){
                //프로퍼티가 존재하면.. 덮어씌운다..

            }else{
                stockInfo[key] = csvItem[key];
            }
        });

        console.log(stockInfo);
        return stockInfo;
    });
});

console.log(dataset);

    var csv = 'Name,Title\n';
    data.forEach(function(row) {
            csv += row.join(',');
            csv += "\n";
    });
 
    console.log(csv);
    var hiddenElement = document.createElement('a');
    hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
    hiddenElement.target = '_blank';
    hiddenElement.download = 'people.csv';
    hiddenElement.click();
}
</script>
 
<button onclick="download_csv()">Download CSV</button> 