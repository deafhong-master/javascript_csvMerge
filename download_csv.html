<script src="https://d3js.org/d3.v4.js"></script>
<script>
var data = [
   ['Foo', 'programmer'],
   ['Bar', 'bus driver'],
   ['Moo', 'Reindeer Hunter']
];
 
 function readCSV(fileNames){
     var queue = [];

    fileNames.forEach( function ( fileName ) {
        var readCSV = new Promise( function(resolve, reject) {
            d3.csv('/stockData/' + fileName+'.csv', function(data){
                resolve(data);
            })
        });
        
        queue.push(readCSV);
    });

    return Promise.all(queue);

 }
 
function download_csv() {
var dataset = [];

//file들을 멀티 선택할 수 있게 추가.

var fileNames = [
    // 'testStock01',
    // 'testStock02',
    'stock01',
    'stock02',
    'stock03',
    'stock04',
    'stock05',
    'stock06',
    'stock07',
    'stock08',
    'stock09',
    'stock10',
    'stock11',
    'stock12',
    'stock13',
    'stock14',
    'stock15',
    'stock16',
    'stock17',
    'stock18',
    'stock19',
    'stock20',
    'stock21',
    'stock22',
    'stock23',
    'stock24',
    'stock25',
    'stock26',
    'stock27',
    'stock28',
    'stock29',
    'stock30',
    'stock31'
];

var getData = readCSV(fileNames);
getData.then(function( csvFileAll ){
    // 1. da
    csvFileAll.forEach(function( csvFile ){
        csvFile.forEach(function( data ){
            var stockInfo = dataset.find( function(stockItem) {
                return stockItem.code == data['code'];
            });

            if( !stockInfo ){
                stockInfo = {
                    'code' : data['code']
                };

                Object.getOwnPropertyNames(data).forEach(function(key){
                    if( stockInfo.hasOwnProperty(key) ){
                        // stockInfo[key] += data[key];
                    }else{
                        stockInfo[key] = data[key];
                    }
                });

                dataset.push(stockInfo); 
            }else{
                Object.getOwnPropertyNames(data).forEach(function(key){
                    if( stockInfo.hasOwnProperty(key) ){
                        if( key !== 'code' || key !== 'name'){
                            stockInfo[key] += data[key];    
                        }
                    }else{
                        stockInfo[key] = data[key];
                    }
                });
            }
        });
    });
    console.log(dataset);
    writeCSV(dataset);
});

function writeCSV( array ){
    var title = ['code', 'name', 'kind', 'kind1'];

    var csv = title.toString();
    csv += '\n';

    array.forEach(function(row) {
        var arr = [];

        title.forEach(function(key){
            if( key == 'code' ){
                if( typeof(row[key]) !== 'string' ){
                    arr.push(('000000'+ parseInt(row[key])).substring(row[key].length));
                }else{
                    arr.push(row[key]);
                }
            }else{
                arr.push(row[key]);
            }
        });

        csv += arr.toString();
        csv += '\n';
    });

    var hiddenElement = document.createElement('a');
    //hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
    hiddenElement.href = 'data:text/csv;charset=utf-8,%EF%BB%BF' + encodeURI(csv);
    hiddenElement.target = '_blank';
    hiddenElement.download = 'mergeStock.csv';
    hiddenElement.click();
}

// d3.csv("stockCodeList.csv", function(data) {
// 	dataset = data.map(function(csvItem) {
//         var stockInfo = dataset.find( function(stockItem) {
//             return stockItem.code == csvItem['code'];
//         });

//         if( !stockInfo ){
//             stockInfo = {
//                 'code' : csvItem['code']
//             }
//         }

//         Object.getOwnPropertyNames(csvItem).forEach(function(key){
//             if( stockInfo.hasOwnProperty(key) ){
//                 //프로퍼티가 존재하면.. 덮어씌운다..

//             }else{
//                 stockInfo[key] = csvItem[key];
//             }
//         });

//         console.log(stockInfo);
//         return stockInfo;
//     });
// });

// console.log(dataset);

    // var csv = 'Name,Title\n';
    // data.forEach(function(row) {
    //         csv += row.join(',');
    //         csv += "\n";
    // });
 
    // console.log(csv);
    // var hiddenElement = document.createElement('a');
    // hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
    // hiddenElement.target = '_blank';
    // hiddenElement.download = 'people.csv';
    // hiddenElement.click();
}
</script>
 
<button onclick="download_csv()">Download CSV</button> 